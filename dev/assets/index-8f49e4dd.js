(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const _=(n,e,t)=>n<e?e:n>t?t:n,le=(n,e,t)=>n+(e-n)*t;class Be{constructor(){this.x=0,this.y=0,this.zoom=1,this.viewportWidth=1,this.viewportHeight=1,this.worldWidth=1,this.worldHeight=1,this.followLerpX=1,this.followLerpY=1}setViewport(e,t){this.viewportWidth=Math.max(1,e),this.viewportHeight=Math.max(1,t),this.clampToBounds()}setBounds(e,t){this.worldWidth=Math.max(1,e),this.worldHeight=Math.max(1,t),this.clampToBounds()}setZoom(e){this.zoom=Math.max(.001,e),this.clampToBounds()}getZoom(){return this.zoom}startFollow(e,t,s){this.followTarget=e,this.followLerpX=_(t,0,1),this.followLerpY=_(s,0,1)}snapToFollowTarget(){const e=this.getDesiredFollowPosition();if(!e){this.clampToBounds();return}this.x=e.x,this.y=e.y,this.clampToBounds()}update(){const e=this.getDesiredFollowPosition();if(!e){this.clampToBounds();return}this.x=le(this.x,e.x,this.followLerpX),this.y=le(this.y,e.y,this.followLerpY),this.clampToBounds()}screenToWorld(e,t){return{x:this.x+e/this.zoom,y:this.y+t/this.zoom}}applyTransform(e){e.setTransform(this.zoom,0,0,this.zoom,-this.x*this.zoom,-this.y*this.zoom)}getDesiredFollowPosition(){if(!this.followTarget)return;const e=this.viewportWidth/this.zoom,t=this.viewportHeight/this.zoom;return{x:this.followTarget.x-e/2,y:this.followTarget.y-t/2}}clampToBounds(){const e=this.viewportWidth/this.zoom,t=this.viewportHeight/this.zoom,s=Math.max(0,this.worldWidth-e),i=Math.max(0,this.worldHeight-t);this.x=_(this.x,0,s),this.y=_(this.y,0,i)}}const Fe=16,O={pacman:10,ghost:11},U={pacman:1,ghost:1},ve={durationMs:1500,intervalMs:120},W={zoom:5,followLerp:{x:.09,y:.09}},We="(hover: none) and (pointer: coarse)",Xe=18,He=1.2,Ke=10,Z=3,$e=5e3,Je=900,Ue=.5,Ye=260,Ve=650,I={0:{texture:"point",size:2.5,score:10},1:{texture:"point",size:4,score:50},2:{texture:"cherry",size:4,score:100},3:{texture:"strawberry",size:4,score:150},4:{texture:"banana",size:4,score:200},5:{texture:"pear",size:4,score:250},6:{texture:"heart",size:4,score:300}};class qe{constructor(){this.listeners={}}on(e,t){const s=this.listeners[e];if(s){s.add(t);return}this.listeners[e]=new Set([t])}off(e,t){var s;(s=this.listeners[e])==null||s.delete(t)}emit(e,t){var s;(s=this.listeners[e])==null||s.forEach(i=>{i(t)})}clear(){Object.keys(this.listeners).forEach(e=>{var t;(t=this.listeners[e])==null||t.clear()})}}const S={ScoreChanged:"score-changed",LivesChanged:"lives-changed"},g={score:0,lives:Z},X=new qe,E={on(n,e){X.on(n,e)},off(n,e){X.off(n,e)},emit(n,e){X.emit(n,e)}};function je(n=0,e=Z){g.score=n,g.lives=e,E.emit(S.ScoreChanged,g.score),E.emit(S.LivesChanged,g.lives)}function Ze(n){g.score+=n,E.emit(S.ScoreChanged,g.score)}function Qe(n=1){const e=Math.max(0,Math.floor(n));return e===0||(g.lives=Math.max(0,g.lives-e),E.emit(S.LivesChanged,g.lives)),g.lives}function et(){return{...g}}class tt{constructor(e){this.x=0,this.y=0,this.angle=0,this.flipX=!1,this.flipY=!1,this.depth=2,this.active=!0,this.moved={x:0,y:0},this.key=e.key,this.direction=e.direction,this.speed=e.speed,this.tile={...e.tile},this.displayWidth=e.displayWidth,this.displayHeight=e.displayHeight,this.state={free:!1,soonFree:!0,scared:!1,dead:!1,animation:"default"}}}class st{constructor(e,t,s){this.x=0,this.y=0,this.angle=0,this.flipX=!1,this.flipY=!1,this.depth=2,this.active=!0,this.moved={x:0,y:0},this.direction={current:"right",next:"right"},this.portalBlinkRemainingMs=0,this.portalBlinkElapsedMs=0,this.tile={...e},this.displayWidth=t,this.displayHeight=s}}const Q=["up","down","left","right"],Y={up:"down",down:"up",left:"right",right:"left"},ee={up:{dx:0,dy:-1},down:{dx:0,dy:1},left:{dx:-1,dy:0},right:{dx:1,dy:0}},N=()=>({collides:!1,penGate:!1,portal:!1,up:!1,down:!1,left:!1,right:!1});class it{constructor(e){var t;this.grid=e,this.height=e.length,this.width=((t=e[0])==null?void 0:t.length)??0}getTileAt(e,t){const s=this.grid[t];return s?s[e]??N():N()}getTilesAt(e){const{x:t,y:s}=e;return{current:this.getTileAt(t,s),up:this.getTileAt(t,s-1),down:this.getTileAt(t,s+1),left:this.getTileAt(t-1,s),right:this.getTileAt(t+1,s)}}toArray(){return this.grid.map(e=>e.map(t=>({...t})))}}const B=16;function x(n,e,t,s,i=B,r="pacman"){const o=s.current,a=s.up,l=s.down,h=s.left,u=s.right,c=r==="ghost",d=(p,w)=>!(!w||c&&p.penGate);return n==="up"?d(o,o.up)||d(a,a.down)?e<0&&e>=-i:!0:n==="down"?d(o,o.down)||d(l,l.up)?e>0&&e<=i:!0:n==="right"?d(o,o.right)||d(u,u.left)?t>0&&t<=i:!0:n==="left"&&(d(o,o.left)||d(h,h.right))?t<0&&t>=-i:!0}function Se(n,e,t=B,s="pacman"){const i=Q.filter(r=>r===Y[e]?!1:x(r,0,0,n,t,s));if(!i.length){const r=Y[e];x(r,0,0,n,t,s)&&i.push(r)}return i}function nt(n,e,t=B,s=x){const{current:i,next:r}=n.direction;return r===i||n.moved.x!==0||n.moved.y!==0?i:(s(r,n.moved.y,n.moved.x,e,t,"pacman")&&(n.direction.current=r,r==="left"||r==="right"?n.moved.x=0:n.moved.y=0),n.direction.current)}function rt(n,e,t,s){const i=ee[e];for(n.moved.x+=i.dx*t,n.moved.y+=i.dy*t;n.moved.x>=s;)n.tile.x+=1,n.moved.x-=s;for(;n.moved.x<=-s;)n.tile.x-=1,n.moved.x+=s;for(;n.moved.y>=s;)n.tile.y+=1,n.moved.y-=s;for(;n.moved.y<=-s;)n.tile.y-=1,n.moved.y+=s}function V(n,e,t){const s=t/2;return{x:n.x*t+s+e.x,y:n.y*t+s+e.y}}function Ee(n,e){const t=V(n.tile,n.moved,e);n.x=t.x,n.y=t.y}function ot(n,e,t){n.tile={...e},n.moved={x:0,y:0},Ee(n,t)}class at{constructor(e=B){this.tileSize=e}canMove(e,t,s,i,r="pacman"){return x(e,t,s,i,this.tileSize,r)}getAvailableDirections(e,t,s){return Se(e,t,this.tileSize,s)}applyBufferedDirection(e,t){return nt(e,t,this.tileSize,(s,i,r,o,a,l)=>x(s,i,r,o,a,l))}advanceEntity(e,t,s){rt(e,t,s,this.tileSize)}syncEntityPosition(e){Ee(e,this.tileSize)}setEntityTile(e,t){ot(e,t,this.tileSize)}}class lt{chooseDirectionAtCenter(e,t,s,i){const r=Se(t,e,s,"ghost");return r.length?r[i.int(r.length)]??e:e}chooseDirectionWhenBlocked(e,t,s,i,r,o){const l=(e==="left"||e==="right"?["up","down"]:["left","right"]).filter(u=>x(u,t,s,i,r,"ghost"));if(l.length>0)return l[o.int(l.length)]??e;const h=Y[e];return x(h,t,s,i,r,"ghost")?h:e}}function v(n,e,t){return n<e?e:n>t?t:n}function b(n,e){var s;const t=(s=n==null?void 0:n.properties)==null?void 0:s.find(i=>i.name===e);return typeof(t==null?void 0:t.value)=="number"?t.value:void 0}class ct{resolveSpawnTile(e,t,s){const i=b(e,"gridX"),r=b(e,"gridY");return typeof i=="number"&&typeof r=="number"?this.clampTilePosition({x:i,y:r},s):e&&typeof e.x=="number"&&typeof e.y=="number"?this.clampTilePosition({x:Math.floor(e.x/s.tileWidth),y:Math.floor(e.y/s.tileHeight)},s):this.clampTilePosition(t,s)}resolveGhostJailBounds(e,t){const s=b(e.ghostHome,"startX")??t.x,i=b(e.ghostHome,"endX")??t.x,r=v(Math.round(Math.min(s,i)),0,e.width-1),o=v(Math.round(Math.max(s,i)),0,e.width-1),a=b(e.ghostHome,"gridY"),l=typeof a=="number"?a:e.ghostHome&&typeof e.ghostHome.y=="number"?Math.round(e.ghostHome.y/e.tileHeight):t.y,h=v(l,0,e.height-1);return{minX:r,maxX:o,y:h}}findReleaseTile(e){const t=v(e.bounds.y-1,0,e.map.height-1),s=[];for(let h=e.bounds.minX;h<=e.bounds.maxX;h+=1){const u={x:h,y:t};u.x===e.avoidTile.x&&u.y===e.avoidTile.y||this.canGhostMoveFromTile(u,e.collisionGrid,e.movementRules)&&s.push(u)}const i=this.clampTilePosition({x:e.currentTile.x,y:t},e.map);if(s.length===0)return i;const r=v(e.currentTile.x,e.bounds.minX,e.bounds.maxX),o=s.reduce((h,u)=>Math.min(h,Math.abs(u.x-r)),Number.POSITIVE_INFINITY),a=s.filter(h=>Math.abs(h.x-r)===o);if(e.preferDirection==="right")return[...a].sort((u,c)=>c.x-u.x)[0]??i;if(e.preferDirection==="left")return[...a].sort((u,c)=>u.x-c.x)[0]??i;const l=e.rng.int(Math.max(1,a.length));return a[l]??i}moveGhostInJail(e,t,s,i,r){if((e.tile.y!==t.y||e.moved.y!==0)&&s.setEntityTile(e,{x:e.tile.x,y:t.y}),e.moved.x===0&&(e.direction!=="left"&&e.direction!=="right"&&(e.direction=i.next()<.5?"right":"left"),e.tile.x<=t.minX&&e.direction==="left"?e.direction="right":e.tile.x>=t.maxX&&e.direction==="right"&&(e.direction="left")),s.advanceEntity(e,e.direction,r),e.tile.x<t.minX||e.tile.x>t.maxX){const o=v(e.tile.x,t.minX,t.maxX);s.setEntityTile(e,{x:o,y:t.y}),e.direction=e.direction==="left"?"right":"left"}}canGhostMoveFromTile(e,t,s){const i=t.getTilesAt(e);return["up","down","left","right"].some(o=>s.canMove(o,0,0,i,"ghost"))}clampTilePosition(e,t){return{x:v(e.x,0,t.width-1),y:v(e.y,0,t.height-1)}}}function H(n){return`${n.x},${n.y}`}class ht{constructor(e){this.portalPairs=new Map,this.lastTeleportTick=new WeakMap;const t=[];for(let s=0;s<e.height;s+=1)for(let i=0;i<e.width;i+=1)e.getTileAt(i,s).portal&&t.push({x:i,y:s});for(let s=0;s+1<t.length;s+=2){const i=t[s],r=t[s+1];this.portalPairs.set(H(i),{...r}),this.portalPairs.set(H(r),{...i})}}tryTeleport(e,t,s){if(e.moved.x!==0||e.moved.y!==0||this.lastTeleportTick.get(e)===s)return!1;const i=H(e.tile),r=this.portalPairs.get(i);if(!r)return!1;const o=t.getTileAt(r.x,r.y);return o.collides&&o.up&&o.right&&o.down&&o.left?!1:(e.tile={...r},e.moved.x=0,e.moved.y=0,this.lastTeleportTick.set(e,s),!0)}}class dt{constructor(e){this.ghostPreviousTiles=new Map,this.ghostsExitingJail=new Set,this.ghostAnimations=new Map,this.pacmanAnimation={frame:0,elapsedMs:0,sequenceIndex:0,active:!1},this.isMoving=!0,this.collisionDebugEnabled=!1,this.hoveredDebugTile=null,this.pointerScreen=null,this.debugPanelText="",this.tick=0,this.map=e.map,this.tileSize=e.tileSize,this.collisionGrid=e.collisionGrid,this.pacmanSpawnTile={...e.pacmanSpawnTile},this.pacman=e.pacman,this.pacmanPreviousTile={...e.pacman.tile},this.ghosts=e.ghosts,this.ghostJailBounds=e.ghostJailBounds}nextTick(){return this.tick+=1,this.tick}}class Te{constructor(){this.images=new Map,this.jsonData=new Map,this.spriteSheets=new Map}async loadJSON(e,t){const s=await fetch(t);if(!s.ok)throw new Error(`Failed to load JSON: ${t}`);const i=await s.json();return this.jsonData.set(e,i),i}async loadImage(e,t){const s=await this.createImage(t);return this.images.set(e,s),s}async loadSpriteSheet(e,t,s,i){const r=await this.createImage(t),o=Math.max(1,Math.floor(r.width/s)),a=Math.max(1,Math.floor(r.height/i)),l={image:r,frameWidth:s,frameHeight:i,frameCount:o*a};return this.spriteSheets.set(e,l),l}getJSON(e){const t=this.jsonData.get(e);if(!t)throw new Error(`JSON asset not found: ${e}`);return t}getImage(e){const t=this.images.get(e);if(!t)throw new Error(`Image asset not found: ${e}`);return t}getSpriteSheet(e){const t=this.spriteSheets.get(e);if(!t)throw new Error(`Spritesheet asset not found: ${e}`);return t}createImage(e){return new Promise((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=()=>s(new Error(`Failed to load image: ${e}`)),i.src=e})}}const ut=85,pt=91,ce={pacman:"assets/sprites/PacMan.png",blinky:"assets/sprites/Blinky.png",clyde:"assets/sprites/Clyde.png",pinky:"assets/sprites/Pinky.png",inky:"assets/sprites/Inky.png",scared:"assets/sprites/Scared.png"};class mt{constructor(){this.assets=new Te,this.tileImageCache=new Map,this.spritesheets=new Map,this.collectibles=new Map}async loadForMap(e,t){const s=new Set;e.tiles.forEach(r=>{r.forEach(o=>{o.imagePath!=="(empty)"&&o.imagePath!=="(unknown)"&&s.add(o.imagePath)})});const i=[];s.forEach(r=>{i.push(this.assets.loadImage(r,`${t}/${r}`))}),Object.entries(ce).forEach(([r,o])=>{i.push(this.assets.loadSpriteSheet(r,o,ut,pt))}),i.push(this.assets.loadImage("point","assets/sprites/Point.png")),await Promise.all(i),s.forEach(r=>{this.tileImageCache.set(r,this.assets.getImage(r))}),Object.keys(ce).forEach(r=>{const o=r;this.spritesheets.set(o,this.assets.getSpriteSheet(r))}),this.collectibles.set("point",this.assets.getImage("point"))}getTileImage(e){return this.tileImageCache.get(e)}getSpriteSheet(e){return this.spritesheets.get(e)}getCollectibleImage(e){return this.collectibles.get(e)}}class ft{constructor(e){this.keyDown=new Set,this.keyDownListeners=new Set,this.pointerMoveListeners=new Set,this.pointerDownListeners=new Set,this.pointerUpListeners=new Set,this.pointerCancelListeners=new Set,this.handleKeyDown=t=>{this.keyDown.add(t.code),this.keyDownListeners.forEach(s=>{s(t)})},this.handleKeyUp=t=>{this.keyDown.delete(t.code)},this.handleBlur=()=>{this.keyDown.clear()},this.handlePointerMove=t=>{this.pointerMoveListeners.forEach(s=>{s(this.toPointerState(t))})},this.handlePointerDown=t=>{this.pointerDownListeners.forEach(s=>{s(this.toPointerState(t))})},this.handlePointerUp=t=>{this.pointerUpListeners.forEach(s=>{s(this.toPointerState(t))})},this.handlePointerCancel=t=>{this.pointerCancelListeners.forEach(s=>{s(this.toPointerState(t))})},this.element=e,window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),window.addEventListener("blur",this.handleBlur),this.element.addEventListener("pointermove",this.handlePointerMove),this.element.addEventListener("pointerdown",this.handlePointerDown),window.addEventListener("pointerup",this.handlePointerUp),window.addEventListener("pointercancel",this.handlePointerCancel)}isKeyDown(e){return this.keyDown.has(e)}onKeyDown(e){return this.keyDownListeners.add(e),()=>{this.keyDownListeners.delete(e)}}onPointerMove(e){return this.pointerMoveListeners.add(e),()=>{this.pointerMoveListeners.delete(e)}}onPointerDown(e){return this.pointerDownListeners.add(e),()=>{this.pointerDownListeners.delete(e)}}onPointerUp(e){return this.pointerUpListeners.add(e),()=>{this.pointerUpListeners.delete(e)}}onPointerCancel(e){return this.pointerCancelListeners.add(e),()=>{this.pointerCancelListeners.delete(e)}}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),window.removeEventListener("blur",this.handleBlur),this.element.removeEventListener("pointermove",this.handlePointerMove),this.element.removeEventListener("pointerdown",this.handlePointerDown),window.removeEventListener("pointerup",this.handlePointerUp),window.removeEventListener("pointercancel",this.handlePointerCancel),this.keyDown.clear(),this.keyDownListeners.clear(),this.pointerMoveListeners.clear(),this.pointerDownListeners.clear(),this.pointerUpListeners.clear(),this.pointerCancelListeners.clear()}toPointerState(e){const t=this.element.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top,buttons:e.buttons,pointerId:e.pointerId,pointerType:e.pointerType,isPrimary:e.isPrimary}}}class wt{constructor(e){this.input=new ft(e)}isKeyDown(e){return this.input.isKeyDown(e)}onKeyDown(e){return this.input.onKeyDown(e)}onPointerMove(e){return this.input.onPointerMove(e)}onPointerDown(e){return this.input.onPointerDown(e)}onPointerUp(e){return this.input.onPointerUp(e)}onPointerCancel(e){return this.input.onPointerCancel(e)}destroy(){this.input.destroy()}}class yt{constructor(e){const t=e.getContext("2d");if(!t)throw new Error("Canvas 2D context is required");this.canvas=e,this.context=t,this.context.imageSmoothingEnabled=!1}resize(e,t){this.canvas.width=Math.max(1,Math.floor(e)),this.canvas.height=Math.max(1,Math.floor(t))}clear(e){this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.fillStyle=e,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.restore()}beginWorld(e){this.context.save(),e.applyTransform(this.context)}endWorld(){this.context.restore()}drawImageCentered(e,t,s,i,r,o=0,a=!1,l=!1){this.context.save(),this.context.translate(t,s),o!==0&&this.context.rotate(o),(a||l)&&this.context.scale(a?-1:1,l?-1:1),this.context.drawImage(e,-i/2,-r/2,i,r),this.context.restore()}drawSpriteFrame(e,t,s,i,r,o,a=0,l=!1,h=!1){const u=Math.max(0,Math.min(t,e.frameCount-1)),c=Math.max(1,Math.floor(e.image.width/e.frameWidth)),d=u%c*e.frameWidth,p=Math.floor(u/c)*e.frameHeight;this.context.save(),this.context.translate(s,i),a!==0&&this.context.rotate(a),(l||h)&&this.context.scale(l?-1:1,h?-1:1),this.context.drawImage(e.image,d,p,e.frameWidth,e.frameHeight,-r/2,-o/2,r,o),this.context.restore()}}class gt{constructor(e){this.renderer=new yt(e)}get context(){return this.renderer.context}resize(e,t){this.renderer.resize(e,t)}clear(e){this.renderer.clear(e)}beginWorld(e){this.renderer.beginWorld(e)}endWorld(){this.renderer.endWorld()}drawImageCentered(e,t,s,i,r,o=0,a=!1,l=!1){this.renderer.drawImageCentered(e,t,s,i,r,o,a,l)}drawSpriteFrame(e,t,s,i,r,o,a=0,l=!1,h=!1){this.renderer.drawSpriteFrame(e,t,s,i,r,o,a,l,h)}}class xt{constructor(){this.timers=new Set,this.paused=!1}delayedCall(e,t){const s={active:!0,paused:!1,delayMs:e,elapsedMs:0,callback:t,cancel:()=>{s.active=!1,this.timers.delete(s)}};return this.timers.add(s),s}setPaused(e){this.paused=e}update(e){if(this.paused||e<=0)return;Array.from(this.timers).forEach(s=>{!s.active||s.paused||(s.elapsedMs+=e,!(s.elapsedMs<s.delayMs)&&(s.active=!1,this.timers.delete(s),s.callback()))})}clear(){this.timers.forEach(e=>{e.active=!1}),this.timers.clear()}}const vt=(n,e)=>n==="sineInOut"?-(Math.cos(Math.PI*e)-1)/2:e;class St{constructor(){this.tweens=new Set,this.paused=!1}setPaused(e){this.paused=e}add(e){const t=e.target,s={};Object.keys(e.to).forEach(r=>{const o=t[r];s[r]=typeof o=="number"?o:0});const i={active:!0,paused:!1,target:e.target,from:s,to:e.to,durationMs:Math.max(1,e.durationMs),elapsedMs:0,ease:e.ease??"linear",onComplete:e.onComplete,cancel:()=>{i.active=!1,this.tweens.delete(i)}};return this.tweens.add(i),i}update(e){if(this.paused||e<=0)return;Array.from(this.tweens).forEach(s=>{var o;if(!s.active||s.paused)return;s.elapsedMs+=e;const i=Math.min(1,s.elapsedMs/s.durationMs),r=vt(s.ease,i);Object.keys(s.to).forEach(a=>{const l=s.from[a]??0,h=s.to[a]??l;s.target[a]=l+(h-l)*r}),i>=1&&(s.active=!1,this.tweens.delete(s),(o=s.onComplete)==null||o.call(s))})}clear(){this.tweens.forEach(e=>{e.active=!1}),this.tweens.clear()}}class Et{constructor(){this.timers=new xt,this.tweens=new St}delayedCall(e,t){return this.timers.delayedCall(e,t)}addTween(e){return this.tweens.add(e)}update(e){this.timers.update(e),this.tweens.update(e)}setPaused(e){this.timers.setPaused(e),this.tweens.setPaused(e)}clear(){this.timers.clear(),this.tweens.clear()}}const he=2147483648,de=1073741824,ue=536870912,K=n=>typeof n=="object"&&n!==null;function Tt(n){const e=!!(n&he),t=!!(n&de),s=!!(n&ue),i=n&~(he|de|ue);let r=0,o=!1;return e&&t&&s?(r=Math.PI/2,o=!0):e&&t&&!s?(r=Math.PI,o=!1):e&&!t&&s?(r=Math.PI/2,o=!1):e&&!t&&!s?(r=0,o=!0):!e&&t&&s?(r=3*Math.PI/2,o=!1):!e&&t&&!s?(r=Math.PI,o=!0):!e&&!t&&s&&(r=3*Math.PI/2,o=!0),{gid:i,flippedHorizontal:e,flippedVertical:t,flippedAntiDiagonal:s,rotation:r,flipped:o}}function Pt(n){const e=s=>n[s],t=s=>!!s;return{collides:t(e("collides")),penGate:t(e("penGate")),portal:t(e("portal")),up:t(e("up")??e("blocksUp")),down:t(e("down")??e("blocksDown")),left:t(e("left")??e("blocksLeft")),right:t(e("right")??e("blocksRight"))}}function Mt(n,e,t,s){let i={up:n.up,right:n.right,down:n.down,left:n.left};t&&([i.left,i.right]=[i.right,i.left]),s&&([i.up,i.down]=[i.down,i.up]);const r=(Math.round(e/(Math.PI/2))%4+4)%4;for(let o=0;o<r;o+=1)i={up:i.left,right:i.up,down:i.right,left:i.down};return{collides:n.collides,penGate:n.penGate,portal:n.portal,...i}}const bt=(n,e)=>{var s;const t=[...e].sort((i,r)=>i.firstgid-r.firstgid);for(let i=0;i<t.length;i+=1){const r=t[i],o=((s=t[i+1])==null?void 0:s.firstgid)??Number.POSITIVE_INFINITY;if(n>=r.firstgid&&n<o)return r}},It=n=>{const e={};return Array.isArray(n)&&n.forEach(t=>{!t||typeof t.name!="string"||(e[t.name]=t.value)}),e},Ct=n=>{var e;return{id:n.id,name:n.name,type:n.type,visible:n.visible,x:n.x,y:n.y,width:n.width,height:n.height,properties:(e=n.properties)==null?void 0:e.map(t=>({name:t.name,type:t.type,value:t.value}))}};function At(n){const e=n.layers.find(c=>K(c)&&c.type==="tilelayer"&&c.name==="Maze"),t=n.layers.find(c=>K(c)&&c.type==="tilelayer"),s=e??t;if(!s||!Array.isArray(s.data))throw new Error("Maze tile layer is required in maze.json");const i=s.width,r=s.height;if(typeof i!="number"||typeof r!="number"||i<=0||r<=0)throw new Error("Maze layer width/height must be positive numbers");const o=new Map,a=new Map;n.tilesets.forEach(c=>{const d=c.firstgid;typeof d!="number"||!Array.isArray(c.tiles)||c.tiles.forEach(p=>{if(!p||typeof p.id!="number")return;const w=d+p.id,f=It(p.properties);o.set(w,Pt(f)),typeof p.image=="string"&&a.set(w,p.image)})});const l=[];for(let c=0;c<r;c+=1){const d=[];for(let p=0;p<i;p+=1){const w=c*i+p,f=s.data[w]??0,m=Tt(f);if(m.gid<=0){d.push({x:p,y:c,rawGid:f,gid:null,localId:null,imagePath:"(empty)",rotation:0,flipX:!1,flipY:!1,collision:N()});continue}const D=bt(m.gid,n.tilesets),P=D?m.gid-D.firstgid:m.gid,T=o.get(m.gid)??N(),L=m.flipped,R=!1,k=Mt(T,m.rotation,L,R);d.push({x:p,y:c,rawGid:f,gid:m.gid,localId:P,imagePath:a.get(m.gid)??"(unknown)",rotation:m.rotation,flipX:L,flipY:R,collision:k})}l.push(d)}const h=n.layers.find(c=>K(c)&&c.type==="objectgroup"&&c.name==="Spawns"),u=((h==null?void 0:h.objects)??[]).map(c=>Ct(c));return{width:i,height:r,tileWidth:n.tilewidth,tileHeight:n.tileheight,widthInPixels:i*n.tilewidth,heightInPixels:r*n.tileheight,tiles:l,collisionByGid:o,imageByGid:a,spawnObjects:u,pacmanSpawn:u.find(c=>c.type==="pacman"),ghostHome:u.find(c=>c.type==="ghost-home")}}class Dt{constructor(){this.assets=new Te}async loadMap(e){const t=await this.assets.loadJSON("maze",e);return At(t)}}function Lt(n){return typeof n=="function"?{next:n,int(e){return e<=0?0:Math.floor(n()*e)}}:n}const Rt={scaredIdle:{start:0,end:7,yoyo:!0,frameRate:4},inkyIdle:{start:0,end:7,yoyo:!0,frameRate:4},clydeIdle:{start:0,end:7,yoyo:!0,frameRate:4},pinkyIdle:{start:0,end:7,yoyo:!0,frameRate:4},blinkyIdle:{start:0,end:7,yoyo:!0,frameRate:4}},q=[0,1,2,3,2,1],$=q[0],kt=20;class _t{constructor(e,t,s=Rt){this.world=e,this.defaultGhostSpeed=t,this.animations=s}start(){this.world.pacmanAnimation=this.createPacmanAnimationPlayback(),this.world.ghosts.forEach(e=>{this.world.ghostAnimations.set(e,this.createAnimationPlayback(`${e.key}Idle`))})}update(e){this.updatePacmanAnimationState(e),this.world.ghosts.forEach(t=>{this.updateGhostAnimationState(t,e)})}updatePacmanAnimationState(e){const t=this.world.pacmanAnimation;if(!t.active){t.frame=$,t.elapsedMs=0,t.sequenceIndex=0;return}const s=1e3/kt;for(t.elapsedMs+=e;t.elapsedMs>=s;){if(t.elapsedMs-=s,t.sequenceIndex+=1,t.sequenceIndex>=q.length){t.active=!1,t.frame=$,t.elapsedMs=0,t.sequenceIndex=0;return}t.frame=q[t.sequenceIndex]}}updateGhostAnimationState(e,t){e.state.scared&&e.state.animation!=="scared"?(e.state.animation="scared",e.speed=.5,this.world.ghostAnimations.set(e,this.createAnimationPlayback("scaredIdle"))):!e.state.scared&&e.state.animation==="scared"&&(e.state.animation="default",e.speed=this.defaultGhostSpeed,this.world.ghostAnimations.set(e,this.createAnimationPlayback(`${e.key}Idle`)));const s=this.world.ghostAnimations.get(e);if(!s)return;const i=this.animations[s.key],r=1e3/i.frameRate;for(s.elapsedMs+=t;s.elapsedMs>=r;){if(s.elapsedMs-=r,!i.yoyo){s.frame=s.frame+1>i.end?i.start:s.frame+1;continue}s.forward===1?s.frame<i.end?s.frame+=1:(s.forward=-1,s.frame-=1):s.frame>i.start?s.frame-=1:(s.forward=1,s.frame+=1)}}createAnimationPlayback(e){const t=this.animations[e];return{key:e,frame:t.start,elapsedMs:0,forward:1}}createPacmanAnimationPlayback(){return{frame:$,elapsedMs:0,sequenceIndex:0,active:!1}}}class Ot{constructor(e,t,s,i){this.world=e,this.camera=t,this.renderer=s,this.canvas=i}start(){this.camera.setBounds(this.world.map.widthInPixels,this.world.map.heightInPixels),this.camera.setZoom(W.zoom),this.camera.startFollow(this.world.pacman,W.followLerp.x,W.followLerp.y),this.handleResize(),this.camera.snapToFollowTarget(),this.onResize=()=>{this.handleResize()},window.addEventListener("resize",this.onResize)}update(){this.camera.update()}destroy(){this.onResize&&(window.removeEventListener("resize",this.onResize),this.onResize=void 0)}handleResize(){this.renderer.resize(window.innerWidth,window.innerHeight),this.camera.setViewport(this.canvas.width,this.canvas.height)}}class zt{constructor(e){this.value=e>>>0}next(){this.value+=1831565813;let e=Math.imul(this.value^this.value>>>15,1|this.value);return e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}int(e){return e<=0?0:Math.floor(this.next()*e)}}const Nt=2166136261,Gt=16777619,Bt=1/13;function Ft(n,e,t){return n<e?e:n>t?t:n}function Wt(n){return`${n.x},${n.y}`}function Pe(n,e){return n.y!==e.y?n.y-e.y:n.x-e.x}function Me(n,e){return e.x>=0&&e.x<n.width&&e.y>=0&&e.y<n.height}function Xt(n,e){var s;if(!Me(n,e))return!1;const t=(s=n.tiles[e.y])==null?void 0:s[e.x];return!t||t.gid===null}function Ht(n,e,t,s){if(!G(n,t))return!1;const i=e.getTilesAt(t);return Q.some(r=>{const o=ee[r],a={x:t.x+o.dx,y:t.y+o.dy};return Xt(n,a)?x(r,0,0,i,s,"pacman"):!1})}function G(n,e){var s;if(!Me(n,e))return!1;const t=(s=n.tiles[e.y])==null?void 0:s[e.x];return!!(t&&t.gid!==null&&!t.collision.penGate)}function Kt(n,e,t,s){return G(n,t)?!Ht(n,e,t,s):!1}function be(n,e,t,s){if(!G(n,t))return[];const i=e.getTilesAt(t),r=[];return Q.forEach(o=>{const a=ee[o],l={x:t.x+a.dx,y:t.y+a.dy};G(n,l)&&x(o,0,0,i,s,"pacman")&&r.push(l)}),r}function pe(n,e,t,s){return be(n,e,t,s).length>0}function $t(n,e,t,s){if(pe(n,e,t,s))return t;for(let i=0;i<n.height;i+=1)for(let r=0;r<n.width;r+=1){const o={x:r,y:i};if(pe(n,e,o,s))return o}return null}function Jt(n,e,t,s){const i=[t],r=new Set,o=[];for(let a=0;a<i.length;a+=1){const l=i[a],h=Wt(l);if(r.has(h))continue;r.add(h);const u=be(n,e,l,s);u.length&&(o.push(l),u.forEach(c=>{i.push(c)}))}return o.sort(Pe),o}function A(n,e){const t=(n^e>>>0)>>>0;return Math.imul(t,Gt)>>>0}function Ut(n,e){let t=Nt;return t=A(t,n.width),t=A(t,n.height),t=A(t,e.x),t=A(t,e.y),n.tiles.forEach(s=>{s.forEach(i=>{t=A(t,i.rawGid)})}),t>>>0}function Yt(n,e,t){if(e<=0||n.length===0)return[];const s=[...n],i=new zt(t);for(let r=s.length-1;r>0;r-=1){const o=i.int(r+1);[s[r],s[o]]=[s[o],s[r]]}return s.slice(0,e).sort(Pe)}function Vt(n){const{map:e,collisionGrid:t,startTile:s,tileSize:i,options:r}=n,o=$t(e,t,s,i);if(!o)return{basePoints:[],powerPoints:[],seed:0};const l=Jt(e,t,o,i).filter(m=>Kt(e,t,m,i)),h=Math.max(0,(r==null?void 0:r.powerPointRatio)??Bt),u=Math.min(l.length,Math.max(0,(r==null?void 0:r.maxPowerPoints)??l.length)),c=Math.min(u,Math.max(0,(r==null?void 0:r.minPowerPoints)??1)),d=Math.round(l.length*h),p=Ft(d,c,u),w=((r==null?void 0:r.seed)??Ut(e,o))>>>0,f=Yt(l,p,w);return{basePoints:l,powerPoints:f,seed:w}}const qt=I[0].size,jt=I[1].size,Zt=96,Qt=1.5,me=.001,fe=.01;function J(n){return`${n.x},${n.y}`}class Ie{constructor(e){this.world=e,this.pointsByTile=new Map,this.eatEffects=[];const t=Vt({map:this.world.map,collisionGrid:this.world.collisionGrid,startTile:this.world.pacman.tile,tileSize:this.world.tileSize}),s=new Set(t.powerPoints.map(i=>J(i)));t.basePoints.forEach(i=>{const r=J(i),o=this.toPointCenter(i),a=s.has(r)?"power":"base";this.pointsByTile.set(r,{tile:i,x:o.x,y:o.y,kind:a})})}update(e){this.consumePointAtPacmanTile(),this.updateEatEffects(e)}getPoints(){return this.pointsByTile.values()}getEatEffects(){return this.eatEffects}consumePointAtPacmanTile(){const e={x:this.world.pacman.tile.x,y:this.world.pacman.tile.y},t=J(e),s=this.pointsByTile.get(t);if(!s||!this.isPacmanCenteredOnPoint(s))return;this.pointsByTile.delete(t);const i=s.kind==="power"?I[1].score:I[0].score;Ze(i),this.triggerPacmanEatAnimation();const r=s.kind==="power"?jt:qt;this.eatEffects.push({x:s.x,y:s.y,elapsedMs:0,durationMs:Zt,sizeStart:r,sizeEnd:r*Qt})}triggerPacmanEatAnimation(){const e=this.world.pacmanAnimation;e.active=!0,e.frame=0,e.elapsedMs=0,e.sequenceIndex=0}isPacmanCenteredOnPoint(e){return Math.abs(this.world.pacman.moved.x)>me||Math.abs(this.world.pacman.moved.y)>me?!1:Math.abs(this.world.pacman.x-e.x)<=fe&&Math.abs(this.world.pacman.y-e.y)<=fe}updateEatEffects(e){for(let t=this.eatEffects.length-1;t>=0;t-=1){const s=this.eatEffects[t];s.elapsedMs+=e,s.elapsedMs>=s.durationMs&&this.eatEffects.splice(t,1)}}toPointCenter(e){return{x:e.x*this.world.tileSize+this.world.tileSize/2,y:e.y*this.world.tileSize+this.world.tileSize/2}}}class es{constructor(e,t,s){this.world=e,this.renderer=t,this.camera=s,this.runsWhenPaused=!0}start(){this.createPanel()}update(){if(!this.world.collisionDebugEnabled){this.world.hoveredDebugTile=null;return}const e=this.world.pointerScreen;if(!e)return;const t=this.camera.screenToWorld(e.x,e.y),s=Math.floor(t.x/this.world.tileSize),i=Math.floor(t.y/this.world.tileSize);if(s<0||i<0||s>=this.world.map.width||i>=this.world.map.height){this.world.hoveredDebugTile=null;return}this.world.hoveredDebugTile={x:s,y:i}}render(){if(this.panel){if(!this.world.collisionDebugEnabled){this.panel.style.display="none",this.panel.textContent="",this.world.debugPanelText="";return}this.panel.style.display="block",this.renderer.beginWorld(this.camera),this.drawCollisionDebugOverlay(),this.renderer.endWorld(),this.world.hoveredDebugTile?this.world.debugPanelText=this.getTileDebugInfo(this.world.hoveredDebugTile):this.world.debugPanelText=`Collision Debug
move mouse over a block to inspect`,this.panel.textContent=this.world.debugPanelText}}destroy(){var e;(e=this.panel)==null||e.remove(),this.panel=void 0}createPanel(){var t;const e="collision-debug-panel";(t=document.getElementById(e))==null||t.remove(),this.panel=document.createElement("pre"),this.panel.id=e,this.panel.style.position="fixed",this.panel.style.left="8px",this.panel.style.top="52px",this.panel.style.margin="0",this.panel.style.padding="6px 8px",this.panel.style.color="#ffffff",this.panel.style.background="rgba(0, 0, 0, 0.78)",this.panel.style.font="12px/1.35 monospace",this.panel.style.whiteSpace="pre",this.panel.style.pointerEvents="none",this.panel.style.zIndex="9999",this.panel.style.border="1px solid rgba(255, 255, 255, 0.2)",this.panel.style.borderRadius="4px",this.panel.style.display="none",document.body.appendChild(this.panel)}drawCollisionDebugOverlay(){const e=this.renderer.context;for(let t=0;t<this.world.map.height;t+=1)for(let s=0;s<this.world.map.width;s+=1){const i=this.world.collisionGrid.getTileAt(s,t);if(!i.collides&&!i.up&&!i.down&&!i.left&&!i.right&&!i.penGate)continue;const r=s*this.world.tileSize,o=t*this.world.tileSize;i.up&&i.right&&i.down&&i.left&&(e.fillStyle="rgba(255, 51, 85, 0.06)",e.fillRect(r,o,this.world.tileSize,this.world.tileSize)),e.strokeStyle=i.penGate?"#00ffff":"#ff3355",e.lineWidth=1,i.up&&(e.beginPath(),e.moveTo(r,o),e.lineTo(r+this.world.tileSize,o),e.stroke()),i.down&&(e.beginPath(),e.moveTo(r,o+this.world.tileSize),e.lineTo(r+this.world.tileSize,o+this.world.tileSize),e.stroke()),i.left&&(e.beginPath(),e.moveTo(r,o),e.lineTo(r,o+this.world.tileSize),e.stroke()),i.right&&(e.beginPath(),e.moveTo(r+this.world.tileSize,o),e.lineTo(r+this.world.tileSize,o+this.world.tileSize),e.stroke())}this.drawDebugMarker(this.world.pacman.tile,"#ffdd00"),this.world.ghosts.forEach(t=>{this.drawDebugMarker(t.tile,"#00ff66")}),this.world.hoveredDebugTile&&this.drawDebugMarker(this.world.hoveredDebugTile,"#33ccff")}drawDebugMarker(e,t){const s=e.x*this.world.tileSize,i=e.y*this.world.tileSize,r=this.renderer.context;r.strokeStyle=t,r.lineWidth=1,r.strokeRect(s+1,i+1,this.world.tileSize-2,this.world.tileSize-2)}getTileDebugInfo(e){var r;const t=(r=this.world.map.tiles[e.y])==null?void 0:r[e.x],s=this.world.collisionGrid.getTileAt(e.x,e.y);if(!t||t.gid===null)return["Collision Debug",`tile: (${e.x}, ${e.y})`,"gid: empty","edges: up:false right:false down:false left:false"].join(`
`);const i=(Math.round(t.rotation/(Math.PI/2))%4+4)%4;return["Collision Debug",`tile: (${e.x}, ${e.y}) gid:${t.gid} local:${t.localId}`,`image: ${t.imagePath}`,`collides:${s.collides} penGate:${s.penGate} portal:${s.portal}`,`edges: up:${s.up} right:${s.right} down:${s.down} left:${s.left}`,`transform: rot:${i*90}deg flipX:${t.flipX} flipY:${t.flipY}`].join(`
`)}}class ts{constructor(e,t,s,i,r){this.world=e,this.movementRules=t,this.decisions=s,this.portalService=i,this.rng=r}update(){this.world.ghostPreviousTiles.clear(),this.world.ghosts.forEach(e=>{if(this.world.ghostPreviousTiles.set(e,{...e.tile}),!e.state.free||this.world.ghostsExitingJail.has(e))return;const t=this.world.collisionGrid.getTilesAt(e.tile);this.movementRules.canMove(e.direction,e.moved.y,e.moved.x,t,"ghost")?(e.moved.x===0&&e.moved.y===0&&(e.direction=this.decisions.chooseDirectionAtCenter(e.direction,t,this.world.tileSize,this.rng)),this.movementRules.advanceEntity(e,e.direction,e.speed)):e.moved.x===0&&e.moved.y===0&&(e.direction=this.decisions.chooseDirectionWhenBlocked(e.direction,e.moved.y,e.moved.x,t,this.world.tileSize,this.rng)),this.portalService.tryTeleport(e,this.world.collisionGrid,this.world.tick),this.movementRules.syncEntityPosition(e)})}}function j(n,e){return n.x===e.x&&n.y===e.y}function ss(n){return j(n.pacmanCurrent,n.ghostCurrent)}function is(n){return j(n.pacmanPrevious,n.ghostCurrent)&&j(n.ghostPrevious,n.pacmanCurrent)}function ns(){return"pacman-hit"}function rs(n){const e=n.resolveOutcome??ns;for(const t of n.ghosts){const s=n.ghostPreviousTiles.get(t)??t.tile,i={pacmanCurrent:n.pacmanCurrent,pacmanPrevious:n.pacmanPrevious,ghostCurrent:t.tile,ghostPrevious:s};if(ss(i))return{ghost:t,contact:"same-tile",outcome:e(t)};if(is(i))return{ghost:t,contact:"tile-crossing",outcome:e(t)}}return null}const we="right";class os{constructor(e,t){this.world=e,this.movementRules=t}update(){const e=this.world.ghosts.filter(s=>s.active&&s.state.free&&!this.world.ghostsExitingJail.has(s)),t=rs({pacmanCurrent:this.world.pacman.tile,pacmanPrevious:this.world.pacmanPreviousTile,ghosts:e,ghostPreviousTiles:this.world.ghostPreviousTiles});!t||t.outcome!=="pacman-hit"||this.applyPacmanHitOutcome()}applyPacmanHitOutcome(){Qe(),this.movementRules.setEntityTile(this.world.pacman,this.world.pacmanSpawnTile),this.world.pacmanPreviousTile={...this.world.pacman.tile},this.world.pacman.direction.current=we,this.world.pacman.direction.next=we,this.world.pacman.portalBlinkRemainingMs=0,this.world.pacman.portalBlinkElapsedMs=0}}const z=.001,as=1e3/60,ls=120;class cs{constructor(e,t,s,i,r){this.world=e,this.movementRules=t,this.jailService=s,this.scheduler=i,this.rng=r,this.ghostReleaseTimers=[]}start(){this.clearReleaseTimers(),this.ghostReleaseTimers=this.world.ghosts.map((e,t)=>{const s=$e+t*Je;return this.scheduler.delayedCall(s,()=>{this.releaseGhost(e,t)})})}update(){this.world.ghosts.forEach(e=>{!e.state.free&&!this.world.ghostsExitingJail.has(e)&&(this.jailService.moveGhostInJail(e,this.world.ghostJailBounds,this.movementRules,this.rng,Ue),this.movementRules.syncEntityPosition(e))})}destroy(){this.clearReleaseTimers()}releaseGhost(e,t){if(!e.active)return;const s={x:this.resolveReleaseLaneX(e,t),y:this.world.ghostJailBounds.y},i=this.resolveReleaseDirection(s.x),r=this.jailService.findReleaseTile({currentTile:s,avoidTile:this.world.pacman.tile,bounds:this.world.ghostJailBounds,map:this.world.map,collisionGrid:this.world.collisionGrid,movementRules:this.movementRules,rng:this.rng,preferDirection:i});this.world.ghostsExitingJail.add(e);const o=V(s,{x:0,y:0},this.world.tileSize),a=()=>{this.startExitTween(e,r)};if(!this.needsAlignment(e,o)){a();return}const l=this.resolveTransitionDurationMs(e,{x:e.x,y:e.y},o,Ye);this.scheduler.addTween({target:e,to:{x:o.x,y:o.y},durationMs:l,ease:"sineInOut",onComplete:()=>{if(!e.active){this.world.ghostsExitingJail.delete(e);return}a()}})}startExitTween(e,t){const s=V(t,{x:0,y:0},this.world.tileSize),i=this.resolveTransitionDurationMs(e,{x:e.x,y:e.y},s,Ve);this.scheduler.addTween({target:e,to:{x:s.x,y:s.y},durationMs:i,ease:"sineInOut",onComplete:()=>{if(!e.active){this.world.ghostsExitingJail.delete(e);return}this.world.ghostsExitingJail.delete(e),this.movementRules.setEntityTile(e,t),e.direction="up",e.state.free=!0,e.state.soonFree=!1}})}needsAlignment(e,t){return Math.abs(e.x-t.x)>z||Math.abs(e.y-t.y)>z}resolveTransitionDurationMs(e,t,s,i){const r=Math.hypot(s.x-t.x,s.y-t.y);if(r<=z)return 1;const o=Math.max(e.speed,z),a=r/o*as,l=Math.min(i,a);return Math.max(ls,Math.round(l))}clearReleaseTimers(){this.ghostReleaseTimers.forEach(e=>{e.cancel()}),this.ghostReleaseTimers=[]}resolveReleaseLaneX(e,t){const s=this.world.ghostJailBounds.minX,i=this.world.ghostJailBounds.maxX,r=Math.round(e.tile.x);if(Number.isFinite(r)&&r>=s&&r<=i)return r;const o=Math.max(1,i-s+1),a=(t%o+o)%o;return s+a}resolveReleaseDirection(e){const t=(this.world.ghostJailBounds.minX+this.world.ghostJailBounds.maxX)/2;return e<=t?"left":"right"}}class hs{constructor(e){var a;this.mount=e,(a=this.mount.querySelector("[data-game-hud]"))==null||a.remove(),this.container=document.createElement("div"),this.container.className="pointer-events-none absolute inset-x-0 bottom-0 z-50 flex items-center justify-between gap-4 bg-black/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.12em] text-zinc-100 sm:text-sm",this.container.style.position="fixed",this.container.style.left="0",this.container.style.right="0",this.container.style.bottom="0",this.container.style.zIndex="9998",this.container.style.pointerEvents="none",this.container.style.display="flex",this.container.style.alignItems="center",this.container.style.justifyContent="space-between",this.container.style.gap="1rem",this.container.style.padding="10px 16px",this.container.style.background="rgba(0, 0, 0, 0.9)",this.container.style.borderTop="1px solid rgba(255, 255, 255, 0.18)",this.container.style.color="#f4f4f5",this.container.style.fontSize="14px",this.container.style.fontWeight="600",this.container.style.letterSpacing="0.12em",this.container.style.textTransform="uppercase",this.container.style.fontFamily='"Orbitron", ui-sans-serif, system-ui, sans-serif',this.container.setAttribute("data-game-hud","true");const t=document.createElement("div");t.className="flex min-w-0 items-center gap-2",t.style.display="flex",t.style.alignItems="center",t.style.gap="0.5rem",t.setAttribute("data-hud-score","true");const s=document.createElement("span");s.className="text-zinc-400",s.style.color="#a1a1aa",s.textContent="Score",this.scoreText=document.createElement("span"),this.scoreText.className="tabular-nums text-zinc-100",this.scoreText.style.color="#f4f4f5",this.scoreText.style.fontVariantNumeric="tabular-nums",this.scoreText.setAttribute("data-hud-score-value","true"),t.append(s,this.scoreText);const i=document.createElement("div");i.className="flex items-center justify-end gap-2",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="flex-end",i.style.gap="0.5rem",i.setAttribute("data-hud-lives","true");const r=document.createElement("span");r.className="text-zinc-400",r.style.color="#a1a1aa",r.textContent="Lives",this.livesIcons=document.createElement("div"),this.livesIcons.className="flex items-center gap-1",this.livesIcons.style.display="flex",this.livesIcons.style.alignItems="center",this.livesIcons.style.gap="0.25rem",this.livesIcons.setAttribute("data-hud-lives-icons","true"),this.livesCountText=document.createElement("span"),this.livesCountText.className="tabular-nums text-zinc-300",this.livesCountText.style.color="#d4d4d8",this.livesCountText.style.fontVariantNumeric="tabular-nums",this.livesCountText.setAttribute("data-hud-lives-value","true"),i.append(r,this.livesIcons,this.livesCountText),this.container.append(t,i);const o=et();this.setScore(o.score),this.setLives(o.lives),this.onScoreChanged=l=>{this.setScore(l)},this.onLivesChanged=l=>{this.setLives(l)},E.on(S.ScoreChanged,this.onScoreChanged),E.on(S.LivesChanged,this.onLivesChanged),this.mount.appendChild(this.container)}destroy(){E.off(S.ScoreChanged,this.onScoreChanged),E.off(S.LivesChanged,this.onLivesChanged),this.container.remove()}setScore(e){this.scoreText.textContent=String(e)}setLives(e){const t=Math.max(0,Math.floor(e));this.livesCountText.textContent=String(t),this.livesIcons.replaceChildren();for(let s=0;s<t;s+=1)this.livesIcons.appendChild(this.createHeartIcon())}createHeartIcon(){const e=document.createElement("img");return e.src="assets/sprites/Heart.png",e.alt="",e.setAttribute("aria-hidden","true"),e.className="h-4 w-4 object-contain",e.style.width="16px",e.style.height="16px",e.style.objectFit="contain",e}}class ds{constructor(e){this.mount=e}start(){this.hud=new hs(this.mount)}update(){}render(){}destroy(){var e;(e=this.hud)==null||e.destroy(),this.hud=void 0}}const us=[{codes:["ArrowLeft","KeyA"],direction:"left"},{codes:["ArrowRight","KeyD"],direction:"right"},{codes:["ArrowUp","KeyW"],direction:"up"},{codes:["ArrowDown","KeyS"],direction:"down"}];class ps{constructor(e,t,s){this.input=e,this.world=t,this.pauseController=s,this.disposers=[],this.activeTouchGesture=null}start(){this.disposers.push(this.input.onKeyDown(e=>this.handleKeyDown(e))),this.disposers.push(this.input.onPointerMove(e=>this.handlePointerMove(e))),this.disposers.push(this.input.onPointerDown(e=>this.handlePointerDown(e))),this.disposers.push(this.input.onPointerUp(e=>this.handlePointerUp(e))),this.disposers.push(this.input.onPointerCancel(e=>this.handlePointerCancel(e)))}update(){const e=this.getDirectionalKeyboardIntent();e&&(this.world.pacman.direction.next=e)}destroy(){this.disposers.forEach(e=>{e()}),this.disposers=[],this.activeTouchGesture=null}handleKeyDown(e){if(!e.repeat){if(e.code==="KeyH"){this.world.ghosts.forEach(t=>{t.state.scared=!t.state.scared});return}if(e.code==="KeyC"){if(e.shiftKey){e.preventDefault(),this.copyDebugPanelText();return}this.world.collisionDebugEnabled=!this.world.collisionDebugEnabled,this.world.collisionDebugEnabled||(this.world.hoveredDebugTile=null,this.world.debugPanelText="");return}e.code==="Space"&&(e.preventDefault(),this.pauseController.togglePause())}}handlePointerMove(e){this.world.pointerScreen={x:e.x,y:e.y};const t=this.getActiveGesture(e.pointerId);if(!t||t.hasCommittedSwipe||this.hasDirectionalKeyboardInput())return;const s=this.resolveSwipeDirection(t,e);s&&(this.world.pacman.direction.next=s,t.hasCommittedSwipe=!0)}handlePointerDown(e){if(this.world.pointerScreen={x:e.x,y:e.y},!this.isTouchLikePointer(e)){this.pauseController.togglePause();return}this.activeTouchGesture={pointerId:e.pointerId,startX:e.x,startY:e.y,hasCommittedSwipe:!1}}handlePointerUp(e){const t=this.getActiveGesture(e.pointerId);t&&(this.isTapGesture(t,e)&&this.pauseController.togglePause(),this.activeTouchGesture=null)}handlePointerCancel(e){var t;((t=this.activeTouchGesture)==null?void 0:t.pointerId)===e.pointerId&&(this.activeTouchGesture=null)}getActiveGesture(e){return!this.activeTouchGesture||this.activeTouchGesture.pointerId!==e?null:this.activeTouchGesture}isTapGesture(e,t){if(e.hasCommittedSwipe)return!1;const{absX:s,absY:i}=this.getGestureMagnitude(e,t);return Math.max(s,i)<=Ke}resolveSwipeDirection(e,t){const{dx:s,dy:i,absX:r,absY:o}=this.getGestureMagnitude(e,t),a=Math.max(r,o);if(a<Xe)return null;const l=Math.min(r,o);return l>0&&a/l<He?null:r>=o?s>=0?"right":"left":i>=0?"down":"up"}getGestureMagnitude(e,t){const s=t.x-e.startX,i=t.y-e.startY;return{dx:s,dy:i,absX:Math.abs(s),absY:Math.abs(i)}}hasDirectionalKeyboardInput(){return this.getDirectionalKeyboardIntent()!==null}getDirectionalKeyboardIntent(){for(const e of us)if(e.codes.some(t=>this.input.isKeyDown(t)))return e.direction;return null}isTouchLikePointer(e){var t;return e.pointerType==="touch"?!0:!e.isPrimary||typeof window>"u"?!1:!!((t=window.matchMedia)!=null&&t.call(window,We).matches)}async copyDebugPanelText(){const e=this.world.debugPanelText;if(!e)return;await this.copyTextToClipboard(e)||(this.world.debugPanelText=`${e}
copy failed (browser blocked clipboard access)`)}async copyTextToClipboard(e){var t;try{if((t=navigator.clipboard)!=null&&t.writeText)return await navigator.clipboard.writeText(e),!0}catch{}try{const s=document.createElement("textarea");s.value=e,s.setAttribute("readonly","true"),s.style.position="fixed",s.style.left="-9999px",document.body.appendChild(s),s.focus(),s.select();const i=document.execCommand("copy");return s.remove(),i}catch{return!1}}}class ms{constructor(e,t,s){this.world=e,this.movementRules=t,this.portalService=s}update(e=0){this.updatePortalBlink(e),this.updateDirectionVisuals(),this.world.pacmanPreviousTile={...this.world.pacman.tile};const t=this.world.collisionGrid.getTilesAt(this.world.pacman.tile);this.movementRules.applyBufferedDirection(this.world.pacman,t),this.movementRules.canMove(this.world.pacman.direction.current,this.world.pacman.moved.y,this.world.pacman.moved.x,t)&&this.movementRules.advanceEntity(this.world.pacman,this.world.pacman.direction.current,U.pacman),this.portalService.tryTeleport(this.world.pacman,this.world.collisionGrid,this.world.tick)&&(this.world.pacman.portalBlinkRemainingMs=ve.durationMs,this.world.pacman.portalBlinkElapsedMs=0),this.movementRules.syncEntityPosition(this.world.pacman)}updatePortalBlink(e){const t=this.world.pacman.portalBlinkRemainingMs??0;if(t<=0){this.world.pacman.portalBlinkRemainingMs=0,this.world.pacman.portalBlinkElapsedMs=0;return}const s=Number.isFinite(e)&&e>0?e:0,i=Math.max(0,t-s);if(this.world.pacman.portalBlinkRemainingMs=i,i<=0){this.world.pacman.portalBlinkElapsedMs=0;return}const r=this.world.pacman.portalBlinkElapsedMs??0;this.world.pacman.portalBlinkElapsedMs=r+s}updateDirectionVisuals(){if(this.world.pacman.direction.current==="right"){this.world.pacman.angle=0,this.world.pacman.flipY=!1;return}if(this.world.pacman.direction.current==="left"){this.world.pacman.angle=180,this.world.pacman.flipY=!0;return}if(this.world.pacman.direction.current==="up"){this.world.pacman.angle=-90;return}this.world.pacman.direction.current==="down"&&(this.world.pacman.angle=90)}}const fs="opacity-100",ye=["grayscale","sepia","saturate-50","brightness-90","contrast-100"],ws="grayscale(0.72) sepia(0.22) saturate(0.55) brightness(0.86) contrast(0.96)";class ys{constructor(e,t){this.world=e,this.mount=t,this.runsWhenPaused=!0,this.overlay=null,this.pausedStateApplied=!1}start(){this.mount.style.transition="filter 200ms ease-out",this.createOverlay(),this.applyPausePresentation()}update(){this.applyPausePresentation()}destroy(){var e;this.mount.classList.remove(...ye),this.mount.style.filter="",(e=this.overlay)==null||e.remove(),this.overlay=null,this.pausedStateApplied=!1}createOverlay(){var i;(i=this.mount.querySelector("[data-pause-overlay]"))==null||i.remove();const e=document.createElement("div");e.className="pointer-events-none absolute inset-0 z-40 flex flex-col items-center justify-center gap-3 bg-gradient-to-b from-black/25 to-black/50 opacity-0 transition-opacity duration-200 ease-out",e.style.position="absolute",e.style.inset="0",e.style.zIndex="60",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.flexDirection="column",e.style.gap="0.75rem",e.style.background="linear-gradient(to bottom, rgba(8, 8, 8, 0.18), rgba(8, 8, 8, 0.34)), repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.025), rgba(255, 255, 255, 0.025) 1px, rgba(0, 0, 0, 0) 1px, rgba(0, 0, 0, 0) 3px)",e.style.opacity="0",e.style.visibility="hidden",e.style.transition="opacity 200ms ease-out",e.setAttribute("data-pause-overlay","true"),e.setAttribute("aria-hidden","true");const t=document.createElement("p");t.className="m-0 rounded-xl border border-zinc-400/50 bg-black/70 px-5 py-3 text-center text-[clamp(2.2rem,8vw,4.8rem)] font-semibold tracking-[0.34em] text-zinc-100 shadow-[0_0_20px_rgba(0,0,0,0.6)] [text-indent:0.34em] max-sm:px-4 max-sm:text-[clamp(2rem,14vw,4rem)] max-sm:tracking-[0.24em] max-sm:[text-indent:0.24em]",t.style.margin="0",t.style.padding="0.7rem 1.2rem",t.style.border="1px solid rgba(220, 220, 220, 0.55)",t.style.borderRadius="0.75rem",t.style.background="rgba(0, 0, 0, 0.55)",t.style.color="#f5f5f4",t.style.fontFamily='"Orbitron", ui-sans-serif, system-ui, sans-serif',t.style.fontWeight="900",t.style.fontSize="clamp(2.6rem, 10vw, 6rem)",t.style.letterSpacing="0.34em",t.style.textIndent="0.34em",t.style.textAlign="center",t.style.textShadow="0 0 18px rgba(0, 0, 0, 0.7)",t.textContent="PAUSED";const s=document.createElement("p");s.className="m-0 rounded-md bg-black/60 px-3 py-1 text-center text-[clamp(0.72rem,2.4vw,1rem)] uppercase tracking-[0.13em] text-zinc-300 max-sm:w-[90vw] max-sm:max-w-[24rem] max-sm:text-[0.7rem] max-sm:tracking-[0.1em] max-sm:leading-[1.35]",s.style.margin="0",s.style.padding="0.28rem 0.6rem",s.style.borderRadius="0.375rem",s.style.background="rgba(0, 0, 0, 0.42)",s.style.color="#e4e4e7",s.style.fontFamily='"Orbitron", ui-sans-serif, system-ui, sans-serif',s.style.fontSize="clamp(0.78rem, 2.4vw, 1.05rem)",s.style.letterSpacing="0.12em",s.style.textAlign="center",s.style.textTransform="uppercase",s.textContent="Tap or press Space to resume",e.append(t,s),this.mount.appendChild(e),this.overlay=e}applyPausePresentation(){var t,s;const e=!this.world.isMoving;e!==this.pausedStateApplied&&(this.pausedStateApplied=e,ye.forEach(i=>{this.mount.classList.toggle(i,e)}),this.mount.style.filter=e?ws:"",(t=this.overlay)==null||t.classList.toggle(fs,e),this.overlay&&(this.overlay.style.opacity=e?"1":"0",this.overlay.style.visibility=e?"visible":"hidden"),(s=this.overlay)==null||s.setAttribute("aria-hidden",e?"false":"true"))}}const gs="#2d2d2d",xs=I[0].size,vs=I[1].size,Ss=new Set([16,17,18,19,20,21]);class Es{constructor(e,t,s,i,r){this.world=e,this.renderer=t,this.camera=s,this.assets=i,this.collectibles=r??new Ie(this.world)}update(e){this.collectibles.update(e)}render(){this.renderer.clear(gs),this.renderer.beginWorld(this.camera),this.drawMap(!1),this.drawPoints(),this.drawEatEffects(),this.drawGhosts(),this.drawJailForeground(),this.drawPacman(),this.renderer.endWorld()}drawMap(e){this.world.map.tiles.forEach(t=>{t.forEach(s=>{this.isRenderableMapTile(s)&&(!e&&this.isJailForegroundTile(s)||this.drawMapTile(s))})})}drawJailForeground(){this.world.map.tiles.forEach(e=>{e.forEach(t=>{!this.isRenderableMapTile(t)||!this.isJailForegroundTile(t)||this.drawMapTile(t)})})}drawMapTile(e){const t=this.assets.getTileImage(e.imagePath);if(!t)return;const s=e.x*this.world.tileSize+this.world.tileSize/2,i=e.y*this.world.tileSize+this.world.tileSize/2;this.renderer.drawImageCentered(t,s,i,this.world.tileSize,this.world.tileSize,e.rotation,e.flipX,e.flipY)}isRenderableMapTile(e){return e.gid!==null&&e.imagePath!=="(empty)"&&e.imagePath!=="(unknown)"}isJailForegroundTile(e){return e.localId!==null&&Ss.has(e.localId)}drawPoints(){const e=this.assets.getCollectibleImage("point");if(e)for(const t of this.collectibles.getPoints()){const s=t.kind==="power"?vs:xs;this.renderer.drawImageCentered(e,t.x,t.y,s,s,0,!1,!1)}}drawEatEffects(){const e=this.assets.getCollectibleImage("point"),t=this.collectibles.getEatEffects();if(!e||!t.length)return;const s=this.renderer.context;t.forEach(i=>{const r=Math.min(1,i.elapsedMs/i.durationMs),o=1-(1-r)*(1-r),a=i.sizeStart+(i.sizeEnd-i.sizeStart)*o,l=(1-r)*(1-r);s.save(),s.globalAlpha=l,s.drawImage(e,i.x-a/2,i.y-a/2,a,a),s.restore()})}drawPacman(){if(!this.isPacmanVisible())return;const e=this.assets.getSpriteSheet("pacman");e&&this.renderer.drawSpriteFrame(e,this.world.pacmanAnimation.frame,this.world.pacman.x,this.world.pacman.y,this.world.pacman.displayWidth,this.world.pacman.displayHeight,this.world.pacman.angle*Math.PI/180,this.world.pacman.flipX,this.world.pacman.flipY)}isPacmanVisible(){if((this.world.pacman.portalBlinkRemainingMs??0)<=0)return!0;const t=this.world.pacman.portalBlinkElapsedMs??0;return Math.floor(t/ve.intervalMs)%2===0}drawGhosts(){this.world.ghosts.forEach(e=>{var r;const t=e.state.scared?"scared":e.key,s=this.assets.getSpriteSheet(t);if(!s)return;const i=((r=this.world.ghostAnimations.get(e))==null?void 0:r.frame)??0;this.renderer.drawSpriteFrame(s,i,e.x,e.y,e.displayWidth,e.displayHeight,e.angle*Math.PI/180,e.flipX,e.flipY)})}}const ge=["inky","clyde","pinky","blinky"];function xe(n,e,t){return n<e?e:n>t?t:n}class Ts{constructor(e={}){this.options=e}async compose(e){const t=this.options.mountId??"game-root",s=document.getElementById(t);if(!s)throw new Error(`Game mount element not found: #${t}`);s.replaceChildren();const i=document.createElement("canvas");i.className="block h-full w-full touch-none transition-[filter] duration-200 ease-out",s.appendChild(i);const r=new Be,o=new gt(i),a=new wt(i),l=new Et,h=new Dt,u=new mt,c=Lt(this.options.rng??Math.random),d=await h.loadMap("assets/mazes/default/maze.json"),p=d.tileWidth||Fe;await u.loadForMap(d,"assets/mazes/default");const w=new it(d.tiles.map(C=>C.map(F=>({...F.collision})))),f=new at(p),m=new ct,D={x:Math.floor(d.width/2),y:Math.floor(d.height/2)},P=m.resolveSpawnTile(d.pacmanSpawn,D,d),T=m.resolveGhostJailBounds(d,P),L=b(d.ghostHome,"ghostCount")??4,R=Math.max(0,Math.round(L)),k=new st(P,O.pacman,O.pacman);f.setEntityTile(k,P);const te=[];for(let C=0;C<R;C+=1){const F=T.maxX-T.minX+1,Ge=T.minX+c.int(Math.max(1,F)),oe={x:xe(Ge,0,d.width-1),y:xe(T.y,0,d.height-1)},ae=new tt({key:ge[C%ge.length],tile:oe,direction:c.next()<.5?"right":"left",speed:U.ghost,displayWidth:O.ghost,displayHeight:O.ghost});f.setEntityTile(ae,oe),te.push(ae)}je(0,Z);const y=new dt({map:d,tileSize:p,collisionGrid:w,pacmanSpawnTile:P,pacman:k,ghosts:te,ghostJailBounds:T}),se=new ht(w),Ce=new lt,Ae=new ps(a,y,e),De=new ms(y,f,se),Le=new cs(y,f,m,l,c),Re=new ts(y,f,Ce,se,c),ke=new os(y,f),_e=new _t(y,U.ghost),Oe=new Ot(y,r,o,i),ie=new Ie(y),ne=new ds(s),ze=new ys(y,s),re=new es(y,o,r),Ne=new Es(y,o,r,u,ie);return{world:y,renderer:o,input:a,scheduler:l,updateSystems:[Ae,De,Le,Re,ke,_e,Oe,ie,ne,ze,re],renderSystems:[Ne,re,ne],destroy:()=>{s.replaceChildren()}}}}function Ps(n,e,t,s=8){const i=Number.isFinite(e)&&e>0?e:0,r=t*s,o=i>r?r:i;let a=n.accumulatorMs+o,l=0;for(;a>=t&&l<s;)a-=t,l+=1;return l===s&&a>=t&&(a=0),{ticks:l,accumulatorMs:a,clampedDeltaMs:o}}class Ms{constructor(e,t,s=1e3/60,i=8){this.state={accumulatorMs:0},this.running=!1,this.lastTimestamp=0,this.frameId=0,this.tick=r=>{if(!this.running)return;this.lastTimestamp===0&&(this.lastTimestamp=r);const o=r-this.lastTimestamp;this.lastTimestamp=r;const a=Ps(this.state,o,this.stepMs,this.maxSubSteps);this.state.accumulatorMs=a.accumulatorMs;for(let h=0;h<a.ticks;h+=1)this.update(this.stepMs);const l=this.stepMs>0?this.state.accumulatorMs/this.stepMs:0;this.render(l),this.frameId=window.requestAnimationFrame(this.tick)},this.update=e,this.render=t,this.stepMs=s,this.maxSubSteps=i}start(){this.running||(this.running=!0,this.lastTimestamp=0,this.state.accumulatorMs=0,this.frameId=window.requestAnimationFrame(this.tick))}stop(){this.running&&(this.running=!1,window.cancelAnimationFrame(this.frameId))}}class bs{constructor(e){this.compositionRoot=e,this.loop=null,this.composed=null,this.started=!1,this.destroyed=!1,this.runtimeControl={pause:()=>{this.pause()},resume:()=>{this.resume()},togglePause:()=>{this.composed&&(this.composed.world.isMoving?this.pause():this.resume())}},this.update=t=>{if(!(!this.composed||this.destroyed)){if(!this.composed.world.isMoving){this.composed.updateSystems.forEach(s=>{s.runsWhenPaused&&s.update(t)});return}this.composed.world.nextTick(),this.composed.scheduler.update(t),this.composed.updateSystems.forEach(s=>{s.update(t)})}},this.render=t=>{!this.composed||this.destroyed||this.composed.renderSystems.forEach(s=>{s.render(t)})}}async start(){this.started||this.destroyed||(this.composed=await this.compositionRoot.compose(this.runtimeControl),this.loop=new Ms(this.update,this.render),this.started=!0,this.composed.updateSystems.forEach(e=>{var t;(t=e.start)==null||t.call(e)}),this.loop.start())}pause(){this.composed&&(this.composed.world.isMoving=!1,this.composed.scheduler.setPaused(!0))}resume(){this.composed&&(this.composed.world.isMoving=!0,this.composed.scheduler.setPaused(!1))}destroy(){var t,s,i,r,o,a;if(this.destroyed)return;this.destroyed=!0,this.started=!1,(t=this.loop)==null||t.stop(),this.loop=null;const e=new Set([...((s=this.composed)==null?void 0:s.renderSystems)??[],...((i=this.composed)==null?void 0:i.updateSystems)??[]]);this.destroySystems(Array.from(e)),(r=this.composed)==null||r.scheduler.clear(),(o=this.composed)==null||o.input.destroy(),(a=this.composed)==null||a.destroy(),this.composed=null}destroySystems(e){e.forEach(t=>{var s;(s=t.destroy)==null||s.call(t)})}}let M=null;function Is(n={}){M==null||M.destroy();const e=new bs(new Ts(n)),t={start:()=>e.start(),pause:()=>e.pause(),resume:()=>e.resume(),destroy:()=>{e.destroy(),M===t&&(M=null)}};return M=t,t}const Cs=Is({mountId:"game-root"});Cs.start();
